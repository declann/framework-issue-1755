import*as b from"./https:/cdn.jsdelivr.net/npm/@tidyjs/tidy/+esm";import*as h from"./https:/cdn.jsdelivr.net/npm/compassql/+esm";import{tableToIPC as E,tableFromArrays as x}from"./https:/cdn.jsdelivr.net/npm/@uwdata/flechette/dist/flechette.mjs";function $({firstName:r,lastName:l,age:u}){console.log("Hello!"),console.log(`Your name is ${r+(l??"")}`),u&&console.log(`Your age is ${u}`)}var v=(r,l)=>{if(!r||!r.length)return[];var u=r[0],o=r.slice(1),n=[];for(var m in u)for(var f=0;f<u[m].length;f++){var s=F(l);if(s[m]=u[m][f],o.length){var i=v(o,s);n=n.concat(i)}else n.push(s)}return n};function F(r){var l={};for(var u in r)l[u]=r[u];return l}var j=({models:r,introspections:l=[],input_domains:u,input_cursors:o,outputs:n,pivot:m=!1})=>{if(console.log("HI"),!r.length)return;let f={model_id:r.map((t,p)=>p),input_cursor_id:o.map((t,p)=>p),formula:n};Object.entries(u).forEach(([t,p])=>{f[t]=p});let s=v(Object.entries(f).map(([t,p])=>({[t]:p})));s=s.map(t=>({...o[t.input_cursor_id],...t}));let i=[];return s.forEach(t=>{let p="ERROR";try{p=r[t.model_id][t.formula](t)}catch(_){console.log(_)}let d={};Object.entries(t).forEach(([_,g])=>{o[0][_]==null,d[_]=g}),d.formula=t.formula,i.push({...d,value:p})}),m?b.tidy(i,b.pivotWider({namesFrom:"formula",valuesFrom:"value"})):i},z=({models:r,introspections:l=[],input_cursors:u,mark:o,encodings:n,width:m,height:f,spec_post_process:s=i=>i})=>{if(!r.length)return;let i=Object.entries(n).filter(([e,a])=>e!="detail_only_proj").map(([e,a])=>({type:a.type??"nominal",channel:e,field:a.name??a})),t={};Object.values(n).filter(({name:e})=>e=="formulae"||e.substr(-3)=="_in").forEach(({name:e,domain:a})=>{t[e]=a});let d=[...Object.values(n).map(e=>e.name).filter(e=>e!="formula"&&e!="value"&&e!="input_cursor_id"&&e.substr(-3)!="_in")],_=Object.values(n).filter(({name:e})=>e=="formula").map(e=>e.domain);_.length&&(d=[...d,..._[0]]);let g=j({models:r,introspections:l,input_domains:t,input_cursors:u,outputs:d,pivot:Object.values(n).filter(e=>e.name=="formula").length==0}),O=h.schema.build(g),y=h.recommend({spec:{data:g,mark:o,encodings:i},chooseBy:"effectiveness"},O),c=h.result.mapLeaves(y.result,function(e){return e}).items[0].toSpec();return c.data={name:"data"},c.datasets={data:g},typeof o=="string"?o={type:o,tooltip:!0}:o.tooltip==null&&(o.tooltip=!0),c.mark=o,m&&(c.width=m),f&&(c.height=f),n.x?.name=="formula"&&(c.encoding.x.axis={labelAngle:0,orient:"top",labelLimit:90}),n.row?.name=="formula"&&(c.encoding.row.header={labelLimit:70}),Object.entries(n).forEach(([e,a])=>{a.format&&(c.encoding[e].format=a.format,c.encoding[e].axis==null&&(c.encoding[e].axis={format:a.format})),a.scale&&(c.encoding[e].scale=a.scale),a.sort&&(c.encoding[e].sort=a.sort),a.zero!=null&&(c.encoding[e].scale={zero:a.zero}),a.nice!=null&&(c.encoding[e].scale={nice:a.nice}),a.grid!=null&&(c.encoding[e].axis={grid:a.grid}),a.legend==!1&&(c.config={legend:{disable:!0}}),a.legend==null&&a.legend!=null&&(c.encoding[e].legend=null),a.independent&&(c.resolve={scale:{[e]:"independent"}})}),s(c)},q=r=>{let l=[...r.cul_functions.values()].filter(o=>o.reason=="input definition").map(o=>o.name).sort(),u=[...r.cul_functions.values()].filter(o=>o.reason=="definition"&&l.indexOf(o.name+"_in")==-1);return`formula | ${l.join(" | ")}
-------- | ${l.map(o=>":--------:").join(" | ")}
 | ${l.map(o=>"<!--<img width=80/>-->").join(" | ")}
${u.map(o=>`${o.name} | ${l.map(n=>r.cul_input_map["0_"+o.name].has(n)?"\u2714\uFE0F":"").join(" | ")}`).join(`
`)}`},w=({models:r,input_domains:l,input_cursors:u,outputs:o,pivot:n=!0})=>{if(n==!1&&console.error("arrow version of calcudata doesnt support pivot false"),!r.length)return;let m={model_id:r.map((i,t)=>t),input_cursor_id:u.map((i,t)=>t)};Object.entries(l).forEach(([i,t])=>{m[i]=t});let f=v(Object.entries(m).map(([i,t])=>({[i]:t})));f=f.map(i=>({...u[i.input_cursor_id],...i}));let s={};return Object.keys(l).forEach(i=>{s[i]=f.map(t=>t[i])}),s.model_id=f.map(i=>i.model_id),s.input_cursor_id=f.map(i=>i.input_cursor_id),o.forEach(i=>{s[i]=f.map(t=>r[t.model_id][i](t))}),E(x(s))};function H(r,l){return r+l}export{H as add,j as calcudata,w as calcudata_arrow,z as calcuvizspec,v as cartesianProduct,q as function_inputs_table,$ as sayHello};
